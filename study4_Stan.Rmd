---
title: "关于小学生跑步的案例"
author: "王敏杰"
date: "`r Sys.Date()`"
output: 
  officedown::rdocx_document:
    number_sections: yes
    df_print: kable
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo     = FALSE,
    warning  = FALSE, 
    message  = FALSE,
    fig.asp  = 0.618,
    dpi      = 300
)
options(digits = 3)
```


我们的课程目标：用R语言生成一份完整的word分析报告，内容包括读取数据，画出图形以及建立模型。



```{r libraries, echo = FALSE}
library(tidyverse)
library(cmdstanr)
check_cmdstan_toolchain(fix = TRUE, quiet = TRUE)
options(mc.cores = parallel::detectCores())
theme_set(bayesplot::theme_default(base_size = 14))
```


# 数据

这里是小学生50米短跑的成绩

```{r}
d <- haven::read_sav("./data/Study 4.sav")

d
```



```{r, results='hide'}
stan_program <- write_stan_file("
data{
  int<lower=0> N;
  vector[N] Selfish;
  vector[N] ZEI;
  vector[N] Embarrass;
  array[N] int<lower=0, upper=1>  Accident;
}

parameters{
  vector[4] a;
  real b;
  vector[4] c;
  real<lower=0> sigma;
}

transformed parameters{
  vector[N] mu;
  vector[N] theta;
  for(i in 1:N) {
      mu[i] = a[1] + a[2] * Selfish[i] + a[3] * ZEI[i] + a[4] * Selfish[i] * ZEI[i];
   theta[i] = c[1] + c[2] * Selfish[i] + c[3] * ZEI[i] + c[4] * Selfish[i] * ZEI[i] + b * Embarrass[i];
  }
}

model{
  for(i in 1:N) {
    Embarrass[i] ~ normal(mu[i], sigma);
     Accident[i] ~ bernoulli_logit(theta[i]);
  }
}

generated quantities {
  real IndexOfModMed;
  real aSSLow;
  real aSSHigh;
  real abLow;
  real abHigh;

  // Index of Moderated Mediation
  IndexOfModMed = a[3] * b;

  // Simple Slopes
  aSSLow  = a[2] + a[3] * (-1);  
  aSSHigh = a[2] + a[3] * (1) ;   
   
  // Conditional Indirect Effects
  abLow  = aSSLow * b;
  abHigh = aSSHigh* b;

}
                                                                
")

stan_data <- list(
  N         = nrow(d),
  Selfish   = d$Selfish,
  ZEI       = d$ZEI,
  Embarrass = d$Embarrass,
  Accident  = d$Accident
)

mod_stan <- cmdstan_model(stan_file = stan_program)

fit_stan <- mod_stan$sample(data = stan_data)
```



```{r}
fit_stan$summary(c("a[1]", "a[2]", "a[3]", "c[1]", "c[2]", "c[3]", "b",
                   "IndexOfModMed", "aSSLow", "aSSHigh", "abLow", "abHigh")) %>% 
  flextable::flextable() %>% 
  flextable::autofit()
```



# 结构方程模型

我们发现年龄和体重也存在关联，所以三者的关系可以是如下形式，

```{r, fig.asp = 0.6}
library(ggdag)

dag_coords <-
  tibble(name = c("Weight", "Age", "Y"),
         x    = c(1, 2, 3),
         y    = c(1, 2, 1))

dagify(Weight ~ Age,
       Y ~ Weight + Age,
       coords = dag_coords) %>%
  
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_text(color = "black", size = 5) +
  geom_dag_edges(edge_color = "black") + 
  scale_x_continuous(NULL, breaks = NULL) +
  scale_y_continuous(NULL, breaks = NULL) +
  ggthemes::theme_tufte()
```



建立简单的结构方程模型

$$
\begin{align}
y_i &\sim \operatorname{Normal}(\mu_y, \; \sigma_y) \\
\mu_y &= b_1 + b_2 \,\text{age}_i + b_3\, \text{weight}_i\\
\text{weight}_i &\sim \operatorname{Normal}(\mu_w, \;\sigma_w) \\
\mu_w &= c_1 + c_2 \,\text{age}_i 
\end{align}
$$



## 用 lavaan 宏包

```{r, echo=TRUE}
library(lavaan)

sem_model <- "
  Weight ~ Age
  Y ~ Weight + Age
"
lavaan_model <- sem(sem_model,
  data = d,
  bootstrap = 500
)
summary(lavaan_model) 
```




```{r, eval=FALSE, echo=TRUE}
library(lavaan)

model <- '
   # regression
     Weight ~ a * Age
     Y ~ cprime * Age + b * Weight  

   # effects
     indirect := a*b
     direct := cprime
     total := cprime + a*b
     prop_mediated := indirect / total
'

fit <- sem(model, data = d)
```


```{r, eval=FALSE, echo=TRUE}
parameterestimates(fit, ci = TRUE)
```


## 用 psych 宏包

```{r, echo=TRUE}
library(psych)

mediation_psych <-
  psych::mediate(Y ~ (Weight) + Age,
    data = d,
    n.iter = 500,
    main = "Moderated mediation (mean centered)"
  )

print(mediation_psych, short = FALSE, digits = 3)
```


```{r, echo=FALSE, out.width="100%"}
par(mar = c(0, 0, 2, 0)) # par(mar = c(bottom, left, top, right))

mod %>%
  psych::mediate.diagram()
```


图中告诉我们，Age 对 Y 的影响分几个部分:

- 直接效应(c') = 0.59

- 间接效应(ab) = 3.95 * (-0.03)  = -0.14

- 总的效应(c)  = 0.45


三者之间的关系是(c' = c - ab, 近似相等)


## 用mediation宏包

```{r, echo=TRUE}
library(mediation)
model_mediator <- lm(Weight ~ Age, data = d)
model_outcome <- lm(Y ~ Weight + Age, data = d)

mediation_result <- mediate(
  model_mediator,
  model_outcome,
  sims = 500,
  treat = "Age",
  mediator = "Weight"
)

mediation_result %>% summary()
```



- Average Causal Mediated Effect (ACME) (the effect of the mediator alone) 
- Average Direct Effect (ADE) (the unmediated effect) 
- Total Effect (ADE+ACME) 








# 贝叶斯版本

## brms

```{r, message=FALSE, warning=FALSE, results='hide', echo=TRUE}
library(brms)

model_mediator <- bf(Weight ~ Age)
model_outcome  <- bf(Y ~ Weight + Age)

brms_result <- 
  brm(model_mediator + model_outcome + set_rescor(FALSE),
      data = d)

brms_result
```


```{r}
print(bayestestR::mediation(brms_result), digits = 4)
```


## Stan

```{r, message=FALSE, warning=FALSE, results='hide', echo=TRUE}
stan_program <- write_stan_file("
data {
  int<lower=0> N;
  vector[N] Weight;
  vector[N] Age;
  vector[N] Y;
}

parameters {
  vector[2] c;
  vector[3] b;
  real<lower=0> sigma_w;
  real<lower=0> sigma_y;
}

transformed parameters {
  vector[N] mu_w;
  vector[N] mu_y;
  for(i in 1:N) {
    mu_w[i] = c[1] + c[2]*Age[i];
    mu_y[i] = b[1] + b[2]*Age[i] + b[3]*Weight[i];
  }
}

model {

  for(i in 1:N) {
    Weight[i] ~ normal(mu_w[i], sigma_w);
    Y[i] ~ normal(mu_y[i], sigma_y);
  }

}

"
)

stan_data <- list(
  N      = nrow(d), 
  Weight = d$Weight, 
  Age    = d$Age, 
  Y      = d$Y
)

mod <- cmdstan_model(stan_file = stan_program)
fit <- mod$sample(data = stan_data)
```




# 分析

```{r}
fit$summary(variables = c("b", "c"))
```

从结果看到：

- $c_2$ (年龄对体重的效应) 和 $b_2$ (年龄对速度的效应)是正的
- $b_3$ (体重对速度的效应)是负的（发生了翻转，如何解释这个翻转？）


综上可知，个体的年龄越大，跑步速度越快，年龄与跑步速度正相关；个体的体重也会随着年龄的增长而增大，年龄与体重正相关；但是在年龄相同时，个体体重越大跑步速度越慢，年龄与体重负相关。因此，并不是体重越大跑步速度越快，而是存在遮掩效应，年龄对于跑步速度的正向影响远远大于体重对于速度的负面影响，体重对速度的负面影响被年龄的正向影响掩盖了。（狐假虎威？）



但是，我们要特别强调，虽然结论解释的通，并不意味着我们的模型就是正确的，我们还需要专业知识指导和引入更多的解释变量来不断改进模型。


\newpage

# 附录

## 模拟遮盖效应

根据《Statistical Rethinking》第二版的第152页，可以模拟这种**遮盖**效应

```{r,, fig.asp=0.9}
Weight <- rnorm(100)
Age    <- rnorm(100, Weight)
Y      <- rnorm(100, Age - Weight)
d_sim  <- data.frame(Y = Y, Age = Age, Weight = Weight)

mod1 <- lm(Y ~ Weight, data = d_sim)
mod2 <- lm(Y ~ Age, data = d_sim)
mod3 <- lm(Y ~ Weight + Age, data = d_sim)

plot1 <- plot_predictions(mod1, condition = "Weight") + 
  ggtitle("lm(Y ~ Weight)")

plot2 <- plot_predictions(mod2, condition = "Age")  + 
  ggtitle("lm(Y ~ Age)")

plot3 <- plot_predictions(mod3, condition = "Weight") + 
  ggtitle("lm(Y ~ Weight + Age)")

plot4 <- plot_predictions(mod3, condition = "Age")  +
  ggtitle("lm(Y ~ Weight + Age)")

library(cowplot)
plot_grid(plot1, plot2, plot3, plot4, ncol = 2)
```


